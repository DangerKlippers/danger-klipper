
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.23">
    
    
      
        <title>Model Predictive Control - Danger Klipper documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="_klipper3d/css/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-3YZJ9658GV"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-3YZJ9658GV",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-3YZJ9658GV",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#model-predictive-control" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Danger Klipper documentation" class="md-header__button md-logo" aria-label="Danger Klipper documentation" data-md-component="logo">
      
  <img src="img/klipper.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Danger Klipper documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Model Predictive Control
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="amber" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="amber"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2m-5.15 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56M14.34 14H9.66c-.1-.66-.16-1.32-.16-2 0-.68.06-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2M12 19.96c-.83-1.2-1.5-2.53-1.91-3.96h3.82c-.41 1.43-1.08 2.76-1.91 3.96M8 8H5.08A7.923 7.923 0 0 1 9.4 4.44C8.8 5.55 8.35 6.75 8 8m-2.92 8H8c.35 1.25.8 2.45 1.4 3.56A8.008 8.008 0 0 1 5.08 16m-.82-2C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2M12 4.03c.83 1.2 1.5 2.54 1.91 3.97h-3.82c.41-1.43 1.08-2.77 1.91-3.97M18.92 8h-2.95a15.65 15.65 0 0 0-1.38-3.56c1.84.63 3.37 1.9 4.33 3.56M12 2C6.47 2 2 6.5 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/DangerKlippers/danger-klipper" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    DangerKlippers/danger-klipper
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Danger Klipper documentation" class="md-nav__button md-logo" aria-label="Danger Klipper documentation" data-md-component="logo">
      
  <img src="img/klipper.svg" alt="logo">

    </a>
    Danger Klipper documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/DangerKlippers/danger-klipper" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    DangerKlippers/danger-klipper
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Danger_Features.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Danger Klipper additions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Features.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Features
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="FAQ.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Frequently Asked Questions
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Releases.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Releases
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Config_Changes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration Changes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Contact.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation and Configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Installation and Configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_1" >
        
          
          <label class="md-nav__link" for="__nav_8_1" id="__nav_8_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_1">
            <span class="md-nav__icon md-icon"></span>
            Installation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Installation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="OctoPrint.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OctoPrint for Klipper
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_2" >
        
          
          <label class="md-nav__link" for="__nav_8_2" id="__nav_8_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Configuration Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_2">
            <span class="md-nav__icon md-icon"></span>
            Configuration Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Config_Reference.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration reference
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Rotation_Distance.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rotation distance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Config_checks.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_4" >
        
          
          <label class="md-nav__link" for="__nav_8_4" id="__nav_8_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Bed Level
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_4">
            <span class="md-nav__icon md-icon"></span>
            Bed Level
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Bed_Level.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bed leveling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Delta_Calibrate.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Delta calibration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Probe_Calibrate.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Probe calibration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="BLTouch.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BL-Touch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Manual_Level.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Manual leveling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Bed_Mesh.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bed Mesh
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Endstop_Phase.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Endstop phase
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Axis_Twist_Compensation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Axis Twist Compensation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_5" >
        
          
          <label class="md-nav__link" for="__nav_8_5" id="__nav_8_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Resonance Compensation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_5">
            <span class="md-nav__icon md-icon"></span>
            Resonance Compensation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Resonance_Compensation.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resonance Compensation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Measuring_Resonances.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Measuring Resonances
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Pressure_Advance.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pressure advance
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="G-Codes.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    G-Codes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8_8" >
        
          
          <label class="md-nav__link" for="__nav_8_8" id="__nav_8_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Command templates
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_8_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8_8">
            <span class="md-nav__icon md-icon"></span>
            Command templates
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Command_Templates.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Commands templates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Status_Reference.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Status reference
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="TMC_Drivers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TMC drivers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Multi_MCU_Homing.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multiple Micro-controller Homing and Probing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Slicers.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Slicers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Skew_Correction.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skew correction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Exclude_Object.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Exclude Objects
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Using_PWM_Tools.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using PWM tools
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Developer Documentation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Developer Documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Code_Overview.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Code overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Kinematics.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kinematics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Protocol.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Protocol
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="API_Server.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API server
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="MCU_Commands.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MCU commands
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="CANBUS_protocol.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CANBUS protocol
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Debugging.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Benchmarks.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Benchmarks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="CONTRIBUTING.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing to Danger-Klipper
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Packaging.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Packaging Klipper
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Device Specific Documents
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Device Specific Documents
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Example_Configs.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example configurations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="SDCard_Updates.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDCard updates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="RPi_microcontroller.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RPi microcontroller
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Beaglebone.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Beaglebone
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Bootloaders.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bootloaders
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Bootloader_Entry.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bootloader Entry
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="CANBUS.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CANBUS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="CANBUS_Troubleshooting.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CANBUS Troubleshooting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="TSL1401CL_Filament_Width_Sensor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TSL1401CL filament width sensor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Hall_Filament_Width_Sensor.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Hall filament width sensor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Eddy_Probe.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Eddy Current Inductive probe
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="Sponsors.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sponsors
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="model-predictive-control">Model Predictive Control<a class="headerlink" href="#model-predictive-control" title="Permanent link">&para;</a></h1>
<p>Model Predictive Control (MPC) is an advanced temperature control method that offers an alternative to traditional PID control. MPC leverages a system model to simulate the temperature of the hotend and adjusts the heater power to align with the target temperature.  </p>
<p>Unlike reactive methods, MPC operates proactively, adjusting in anticipation of temperature fluctuations. It utilizes a model of the hotend, considering factors such as the thermal masses of the system, heater power, heat loss to ambient air, and fans, and heat transfer into the filament. This model allows MPC to predict the amount of heat energy that will be dissipated from the hotend over a given duration, and it compensates for this by adjusting the heater power accordingly. As a result, MPC can accurately calculate the necessary heat energy input to maintain a steady temperature or to transition to a new temperature.</p>
<p>MPC offers several advantages over PID control:</p>
<ul>
<li><strong>Faster and more responsive temperature control:</strong> MPC’s proactive approach allows it to respond more quickly and accurately to changes in temperature from fans or flow rate changes. </li>
<li><strong>Broad functionality with single calibration:</strong> Once calibrated, MPC functions effectively across a wide range of printing temperatures.  </li>
<li><strong>Simplified calibration process:</strong> MPC is easier to calibrate compared to traditional PID control. </li>
<li><strong>Compatibility with all hotend sensor types:</strong> MPC works with all types of hotend sensors, including those that produce noisy temperature readings.</li>
<li><strong>Versatility with heater types:</strong> MPC performs well with standard cartridge heaters and PTC heaters.</li>
<li><strong>Effective for high and low flow hotends:</strong> Regardless of the flow rate of the hotend, MPC maintains effective temperature control.     </li>
</ul>
<blockquote>
<p>[!CAUTION]
This feature controls the portions of the 3D printer that can get very hot. All standard Danger Klipper warnings apply. Please report all issues and bugs to github or discord.</p>
</blockquote>
<h1 id="basic-configuration">Basic Configuration<a class="headerlink" href="#basic-configuration" title="Permanent link">&para;</a></h1>
<p>To use MPC as the temperature controller for the extruder use the following basic configuration block.</p>
<div class="highlight"><pre><span></span><code>[extruder]
control: mpc
heater_power: 50  
cooling_fan: fan
filament_diameter: 1.75
filament_density: 1.20
filament_heat_capacity: 1.8 
</code></pre></div>

<ul>
<li><code>control: mpc</code><br />
<em>Required</em><br />
  The temperature control method.</li>
</ul>
<ul>
<li><code>heater_power: 50</code><br />
<em>Required</em> <br />
  The nameplate heater power in watts.<br />
  For a PTC, a non-linear heater, MPC may not work optimally due
  to the change in power output relative to heater temperature for this style of
  heater. Setting heater_power to the power output at the expected printing
  temperature is recommended.</li>
</ul>
<ul>
<li><code>cooling_fan: fan</code><br />
<em>Default Value: fan</em><br />
  This is the fan that is cooling extruded filament and the hotend. 
  Specifying "fan" will automatically use the part cooling fan.</li>
</ul>
<ul>
<li><code>filament_diameter: 1.75</code><br />
<em>Default Value: 1.75 (mm)</em><br />
  This is the filament diameter.  </li>
</ul>
<ul>
<li><code>filament_density: 1.20</code> <br />
<em>Default Value: 1.20 (g/mm^3)</em><br />
  This is the material density of the filament being printed.</li>
</ul>
<ul>
<li><code>filament_heat_capacity: 1.80</code><br />
<em>Default Value: 1.80 (J/g/K)</em><br />
  This is the material specific heat capacity of the filament being printed.  </li>
</ul>
<h2 id="optional-config-parameters">Optional Config Parameters<a class="headerlink" href="#optional-config-parameters" title="Permanent link">&para;</a></h2>
<p>These can be specified in the config but should not need to be changed from the default values for most users.</p>
<ul>
<li><code>maximum_retract:</code><br />
<em>Default Value: 2.0 (mm)</em><br />
  This value clamps how much the extruder is allowed to go backwards in a single period during MPC FFF calculations. This lets the filament power go negative and add a small amount of energy to the system.  </li>
</ul>
<ul>
<li><code>target_reach_time:</code><br />
<em>Default Value: 2.0 (sec)</em>  </li>
</ul>
<ul>
<li><code>smoothing:</code><br />
<em>Default Value: 0.83 (sec)</em><br />
  This parameter affects how quickly the model learns and it represents the ratio of temperature difference applied per second. A value of 1.0 represents no smoothing used in the model.  </li>
</ul>
<ul>
<li><code>min_ambient_change:</code><br />
<em>Default Value: 1.0 (deg C/s)</em><br />
  Larger values of MIN_AMBIENT_CHANGE will result in faster convergence but will also cause the simulated ambient temperature to flutter somewhat chaotically around the ideal value.  </li>
</ul>
<ul>
<li><code>steady_state_rate:</code><br />
<em>Default Value: 0.5 (deg C/s)</em>  </li>
</ul>
<ul>
<li><code>ambient_temp_sensor: temperature_sensor &lt;sensor_name&gt;</code><br />
<em>Default Value: MPC ESTIMATE</em><br />
  It is recommended not to specify this parameter and let MPC will estimate. This is used for initial state temperature and calibration but not for actual control.
  Any temperature sensor could be used, but the sensor should be in proximity to the hotend or measuring the ambient air surrounding the hotend.  </li>
</ul>
<h2 id="ptc-heater-power">PTC Heater Power<a class="headerlink" href="#ptc-heater-power" title="Permanent link">&para;</a></h2>
<p>The <code>heater power:</code> for PTC style heaters is recommended to be set at the normal print temperature for the printer. Some common PTC heaters are given below for reference. If your heater is not listed the manufacturer should be able to provide a temperature and power curve.</p>
<table>
<thead>
<tr>
<th style="text-align: center;">Heater Temp (C)</th>
<th style="text-align: center;">Rapido 2 (W)</th>
<th style="text-align: center;">Rapido 1 (W)</th>
<th style="text-align: center;">Dragon Ace old (W)</th>
<th style="text-align: center;">Dragon Ace new (W)</th>
<th style="text-align: center;">Revo 40 (W)</th>
<th style="text-align: center;">Revo 60 (W)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">180</td>
<td style="text-align: center;">72</td>
<td style="text-align: center;">52</td>
<td style="text-align: center;">51</td>
<td style="text-align: center;">66</td>
<td style="text-align: center;">30</td>
<td style="text-align: center;">45</td>
</tr>
<tr>
<td style="text-align: center;">200</td>
<td style="text-align: center;">70</td>
<td style="text-align: center;">51</td>
<td style="text-align: center;">48</td>
<td style="text-align: center;">63</td>
<td style="text-align: center;">29</td>
<td style="text-align: center;">44</td>
</tr>
<tr>
<td style="text-align: center;">220</td>
<td style="text-align: center;">67</td>
<td style="text-align: center;">50</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">28</td>
<td style="text-align: center;">43</td>
</tr>
<tr>
<td style="text-align: center;">240</td>
<td style="text-align: center;">65</td>
<td style="text-align: center;">49</td>
<td style="text-align: center;">44</td>
<td style="text-align: center;">58</td>
<td style="text-align: center;">28</td>
<td style="text-align: center;">42</td>
</tr>
<tr>
<td style="text-align: center;">260</td>
<td style="text-align: center;">64</td>
<td style="text-align: center;">48</td>
<td style="text-align: center;">43</td>
<td style="text-align: center;">55</td>
<td style="text-align: center;">27</td>
<td style="text-align: center;">40</td>
</tr>
<tr>
<td style="text-align: center;">280</td>
<td style="text-align: center;">62</td>
<td style="text-align: center;">47</td>
<td style="text-align: center;">41</td>
<td style="text-align: center;">53</td>
<td style="text-align: center;">27</td>
<td style="text-align: center;">39</td>
</tr>
<tr>
<td style="text-align: center;">300</td>
<td style="text-align: center;">60</td>
<td style="text-align: center;">46</td>
<td style="text-align: center;">39</td>
<td style="text-align: center;">51</td>
<td style="text-align: center;">26</td>
<td style="text-align: center;">38</td>
</tr>
</tbody>
</table>
<h2 id="filament-feed-forward-configuration">Filament Feed Forward Configuration<a class="headerlink" href="#filament-feed-forward-configuration" title="Permanent link">&para;</a></h2>
<p>The filament feed forward (FFF) feature allows MPC to look forward and see changes in extrusion rates which could require more or less heat input to maintain target temperature. This feature substantially improves the accuracy and responsiveness of the model during printing. It is enabled by default and can be defined is more detail with the <code>filament_density</code> and <code>filament_heat_capacity</code> config parameters. The default values are set to cover a wide range of standard materials including ABS, ASA, PLA, PETG. </p>
<p>FFF parameters can be set, for the printer session, via the <code>MPC_SET</code> G-Code command:  </p>
<p><code>MPC_SET HEATER=&lt;heater&gt; FILAMENT_DENSITY=&lt;value&gt; FILAMENT_HEAT_CAPACITY=&lt;value&gt; [FILAMENT_TEMP=&lt;sensor|ambient|&lt;value&gt;&gt;]</code></p>
<ul>
<li><code>HEATER</code>:<br />
  Only extruder is supported</li>
</ul>
<ul>
<li><code>FILAMENT_DENSITY</code>:<br />
  Filament density in g/mm^3</li>
</ul>
<ul>
<li><code>FILAMENT_HEAT_CAPACITY</code>:<br />
  Filament heat capacity in J/g/K</li>
</ul>
<ul>
<li><code>FILAMENT_TEMP</code>:<br />
  This can be set to either <code>sensor</code>, <code>ambient</code>, or a set temperature value. FFF will use the specific energy required to heat the filament and the power loss will be calculated based on the temperature delta.  </li>
</ul>
<p>For example, updating the filament material properties for ASA would be:   </p>
<div class="highlight"><pre><span></span><code>MPC_SET HEATER=extruder FILAMENT_DENSITY=1.07 FILAMENT_HEAT_CAPACITY=1.7  
</code></pre></div>

<h2 id="filament-physical-properties">Filament Physical Properties<a class="headerlink" href="#filament-physical-properties" title="Permanent link">&para;</a></h2>
<p>MPC works best knowing how much energy (in Joules) it takes to heat 1mm of filament by 1°C. The material values from the tables below have been curated from popular filament manufacturers and material data references. These values are sufficient for MPC to implement the FFF feature.  Advanced users could tune the <code>filament_density</code> and <code>filament_heat_capacity</code> parameters based on manufacturers datasheets. </p>
<h3 id="common-materials">Common Materials<a class="headerlink" href="#common-materials" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Material</th>
<th style="text-align: center;">Density [g/cm³]</th>
<th style="text-align: center;">Specific heat [J/g/K]</th>
</tr>
</thead>
<tbody>
<tr>
<td>PLA</td>
<td style="text-align: center;">1.25</td>
<td style="text-align: center;">1.8 - 2.2</td>
</tr>
<tr>
<td>PETG</td>
<td style="text-align: center;">1.27</td>
<td style="text-align: center;">1.7 - 2.2</td>
</tr>
<tr>
<td>PC+ABS</td>
<td style="text-align: center;">1.15</td>
<td style="text-align: center;">1.5 - 2.2</td>
</tr>
<tr>
<td>ABS</td>
<td style="text-align: center;">1.06</td>
<td style="text-align: center;">1.25 - 2.4</td>
</tr>
<tr>
<td>ASA</td>
<td style="text-align: center;">1.07</td>
<td style="text-align: center;">1.3 - 2.1</td>
</tr>
<tr>
<td>PA6</td>
<td style="text-align: center;">1.12</td>
<td style="text-align: center;">2 - 2.5</td>
</tr>
<tr>
<td>PA</td>
<td style="text-align: center;">1.15</td>
<td style="text-align: center;">2 - 2.5</td>
</tr>
<tr>
<td>PC</td>
<td style="text-align: center;">1.20</td>
<td style="text-align: center;">1.1 - 1.9</td>
</tr>
<tr>
<td>TPU</td>
<td style="text-align: center;">1.21</td>
<td style="text-align: center;">1.5 - 2</td>
</tr>
<tr>
<td>TPU-90A</td>
<td style="text-align: center;">1.15</td>
<td style="text-align: center;">1.5 - 2</td>
</tr>
<tr>
<td>TPU-95A</td>
<td style="text-align: center;">1.22</td>
<td style="text-align: center;">1.5 - 2</td>
</tr>
</tbody>
</table>
<h3 id="common-carbon-fiber-filled-materials">Common Carbon Fiber Filled Materials<a class="headerlink" href="#common-carbon-fiber-filled-materials" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Material</th>
<th style="text-align: center;">Density [g/cm³]</th>
<th style="text-align: center;">Specific heat [J/g/K]</th>
</tr>
</thead>
<tbody>
<tr>
<td>ABS-CF</td>
<td style="text-align: center;">1.11</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>ASA-CF</td>
<td style="text-align: center;">1.11</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>PA6-CF</td>
<td style="text-align: center;">1.19</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>PC+ABS-CF</td>
<td style="text-align: center;">1.22</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>PC+CF</td>
<td style="text-align: center;">1.36</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>PLA-CF</td>
<td style="text-align: center;">1.29</td>
<td style="text-align: center;">^</td>
</tr>
<tr>
<td>PETG-CF</td>
<td style="text-align: center;">1.30</td>
<td style="text-align: center;">^</td>
</tr>
</tbody>
</table>
<p>^ Use the specific heat from the base polymer  </p>
<h1 id="calibration">Calibration<a class="headerlink" href="#calibration" title="Permanent link">&para;</a></h1>
<p>The MPC default calibration routine takes the following steps:</p>
<blockquote>
<ol>
<li>Cool to ambient: The calibration routine needs to know the approximate ambient temperature and waits until the hotend temperature stabilises and stops decreasing relative to ambient.</li>
<li>Heat past 200°C: Measure the point where the temperature is increasing most rapidly, and the time and temperature at that point. Also, three temperature measurements are needed at some point after the initial latency has taken effect. </li>
<li>Hold temperature while measuring ambient heat-loss: At this point enough is known for the MPC algorithm to engage. The calibration routine makes a best guess at the overshoot past 200°C which will occur and targets this temperature for about a minute while ambient heat-loss is measured without and with the fan engaged (if a <code>cooling_fan</code> is specified).</li>
<li>The MPC calibration routine creates the appropriate model constants. At this time the model parameters are temporary and not yet saved to the printer configuration.  </li>
</ol>
</blockquote>
<p>The MPC calibration routine must be run for each heater, to be controlled by MPC, in order to determine the model parameters. For an MPC calibration to be successful an extruder must be able to reach 200C. Calibration is performed with the following G-code command.</p>
<p><code>MPC_CALIBRATE HEATER=&lt;heater&gt; [TARGET=&lt;temperature&gt;] [FAN_BREAKPOINTS=&lt;value&gt;]</code>  </p>
<ul>
<li><code>HEATER=&lt;heater&gt;</code>:<br />
  The extruder heater to be calibrated.  </li>
</ul>
<ul>
<li><code>TARGET=&lt;temperature&gt;</code>:<br />
<em>Default Value: 200 (deg C)</em><br />
  Sets the calibration temperature. The default of 200C is a good target for the extruder. MPC calibration is temperature independent, so calibrating the extruder at higher temperatures will not necessarily produce better model parameters. This is an area of exploration for advanced users.  </li>
</ul>
<ul>
<li><code>FAN_BREAKPOINTS=&lt;value&gt;</code>:<br />
<em>Default Value: 3</em><br />
  Sets the number off fan setpoint to test during calibration. An arbitrary number of breakpoints can be specified e.g. 7 breakpoints would result in (0, 16%, 33%, 50%, 66%, 83%, 100%) fan speeds.
  It is recommended to use a number that will capture one or more test points below the lowest level of fan normally used. For example, if 20% fan is the lowest commonly used speed, using 11 break points is recommended to test 10% and 20% fan at the low range.  </li>
</ul>
<p>Default calibration of the hotend with seven fan breakpoints:  </p>
<div class="highlight"><pre><span></span><code>MPC_CALIBRATE HEATER=extruder FAN_BREAKPOINTS=7
</code></pre></div>

<blockquote>
<p>[!NOTE]
Ensure that the part cooling fan is off before starting calibration.  </p>
</blockquote>
<p>After successful  calibration the method will generate the key model parameters into the log for future reference.  </p>
<p><img alt="Calibration Parameter Output" src="/docs/img/MPC_calibration_output.png" /></p>
<p>A <code>SAVE_CONFIG</code> command is then required to commit these calibrated model parameters to the printer config or the user can manually update the values. The <em>SAVE_CONFIG</em> block should then look like: </p>
<div class="highlight"><pre><span></span><code>#*# &lt;----------- SAVE_CONFIG -----------&gt;
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*# [extruder]
#*# control = mpc
#*# block_heat_capacity = 22.3110
#*# sensor_responsiveness = 0.0998635
#*# ambient_transfer = 0.155082
#*# fan_ambient_transfer=0.155082, 0.20156, 0.216441
</code></pre></div>

<blockquote>
<p>[!NOTE]
If the [extruder] section is in a .cfg file other than printer.cfg the <code>SAVE_CONFIG</code> command may not be able to write the calibration parameters and klippy will provide an error. </p>
</blockquote>
<p>These model parameters are not suitable for pre-configuration or are not explicitly determinable. Advanced users could tweak these post calibration based on the following guidance: Slightly increasing these values will increase the temperature where MPC settles and slightly decreasing them will decrease the settling temperature.  </p>
<ul>
<li><code>block_heat_capacity:</code><br />
  Heat capacity of the heater block in (J/K).  </li>
</ul>
<ul>
<li><code>ambient_transfer:</code><br />
  Heat transfer from heater block to ambient in (W/K).  </li>
</ul>
<ul>
<li><code>sensor_responsiveness:</code><br />
  A single constant representing the coefficient of heat transfer from heater block to sensor and heat capacity of the sensor in (K/s/K).  </li>
</ul>
<ul>
<li><code>fan_ambient_transfer:</code><br />
  Heat transfer from heater block to ambient in with fan enabled in (W/K).  </li>
</ul>
<h1 id="support-macros">Support Macros<a class="headerlink" href="#support-macros" title="Permanent link">&para;</a></h1>
<h2 id="temperature-wait">Temperature Wait<a class="headerlink" href="#temperature-wait" title="Permanent link">&para;</a></h2>
<p>The following macro can be used to replace <code>M109</code> hotend temperature set and <code>M190</code> bed temperature set G-code commands with a macro utilizing <code>temperature_wait</code> G-codes. This can be utilized in systems where the sensor temperature takes an extended time to converge on the set temperature. </p>
<blockquote>
<p>[!NOTE]
This behaviour occurs primarily because MPC controls the modelled block temperature and not the hotend temperature sensor. For almost all cases, when temperature sensor overshoot/undershoot occurs, the block modelled temperature will be correctly at the set temperature. However, the Klipper system performs actions based on the sensor temperature only which can lead to undesirable delays in print actions with stock <code>M109</code> and <code>M190</code> commands.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{&#39;%s%s&#39; % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}


[gcode_macro M190] # Wait Bed Temp
rename_existing: M190.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{&#39;%s%s&#39; % (p, params[p])}{% endfor %}   # Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+5}  # Wait for bed temp (within n degrees)
    {% endif %}
</code></pre></div>

<h3 id="setting-fff-parameters-from-the-slicer">Setting FFF Parameters From The Slicer<a class="headerlink" href="#setting-fff-parameters-from-the-slicer" title="Permanent link">&para;</a></h3>
<p>This macro will set FFF parameters automatically when the material type is passed from the slicer. </p>
<div class="highlight"><pre><span></span><code><span class="k">[gcode_macro _SET_MPC_MATERIAL]</span>
<span class="na">description</span><span class="o">:</span><span class="w"> </span><span class="s">Set heater MPC parameters for a given material</span>
<span class="na">variable_filament_table</span><span class="o">:</span>
<span class="w">    </span><span class="c1">## Update this table to adjust material settings</span>
<span class="w">    </span><span class="na">{</span>
<span class="w">        </span><span class="c1">## ( density, heat capacity )  # suggested heat capacity range</span>
<span class="w">        </span><span class="na">&quot;PLA&quot;</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.25, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.80 - 2.20</span>
<span class="w">        </span><span class="na">&quot;PETG&quot;</span><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.27, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.70 - 2.20</span>
<span class="w">        </span><span class="na">&quot;PC+ABS&quot;</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.15, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.50 - 2.20</span>
<span class="w">        </span><span class="na">&quot;ABS&quot;</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.06, 2.40 ),</span><span class="w">  </span><span class="c1"># 1.25 - 2.40</span>
<span class="w">        </span><span class="na">&quot;ASA&quot;</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.07, 2.10 ),</span><span class="w">  </span><span class="c1"># 1.30 - 2.10</span>
<span class="w">        </span><span class="na">&quot;PA6&quot;</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.12, 2.50 ),</span><span class="w">  </span><span class="c1"># 2.00 - 2.50</span>
<span class="w">        </span><span class="na">&quot;PA&quot;</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.15, 2.50 ),</span><span class="w">  </span><span class="c1"># 2.00 - 2.50</span>
<span class="w">        </span><span class="na">&quot;PC&quot;</span><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.20, 1.90 ),</span><span class="w">  </span><span class="c1"># 1.10 - 1.90</span>
<span class="w">        </span><span class="na">&quot;TPU&quot;</span><span class="w">       </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.21, 2.00 ),</span><span class="w">  </span><span class="c1"># 1.50 - 2.00</span>
<span class="w">        </span><span class="na">&quot;TPU-90A&quot;</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.15, 2.00 ),</span><span class="w">  </span><span class="c1"># 1.50 - 2.00</span>
<span class="w">        </span><span class="na">&quot;TPU-95A&quot;</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.22, 2.00 ),</span><span class="w">  </span><span class="c1"># 1.50 - 2.00</span>
<span class="w">        </span><span class="na">&quot;ABS-CF&quot;</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.11, 2.40 ),</span><span class="w">  </span><span class="c1"># 1.25 - 2.40</span>
<span class="w">        </span><span class="na">&quot;ASA-CF&quot;</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.11, 2.10 ),</span><span class="w">  </span><span class="c1"># 1.30 - 2.10</span>
<span class="w">        </span><span class="na">&quot;PA6-CF&quot;</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.19, 2.50 ),</span><span class="w">  </span><span class="c1"># 2.00 - 2.50</span>
<span class="w">        </span><span class="na">&quot;PC+ABS-CF&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.22, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.50 - 2.20</span>
<span class="w">        </span><span class="na">&quot;PC+CF&quot;</span><span class="w">     </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.36, 1.90 ),</span><span class="w">  </span><span class="c1"># 1.10 - 1.90</span>
<span class="w">        </span><span class="na">&quot;PLA-CF&quot;</span><span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.29, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.80 - 2.20</span>
<span class="w">        </span><span class="na">&quot;PETG-CF&quot;</span><span class="w">   </span><span class="o">:</span><span class="w"> </span><span class="s">( 1.30, 2.20 ),</span><span class="w">  </span><span class="c1"># 1.70 - 2.20</span>
<span class="w">    </span><span class="na">}</span>
<span class="na">gcode</span><span class="o">:</span>
<span class="w">    </span><span class="na">{% set material</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.MATERIAL | upper %}</span>
<span class="w">    </span><span class="na">{% set heater</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.HEATER | default(&#39;extruder&#39;) %}</span>
<span class="w">    </span><span class="na">{% set extruder_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">printer.configfile.settings[heater] %}</span>

<span class="w">    </span><span class="na">{% if material in filament_table %}</span>
<span class="w">        </span><span class="na">{% set (density, heat_capacity)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">filament_table[material] %}</span>

<span class="w">        </span><span class="na">RESPOND PREFIX</span><span class="o">=</span><span class="s">🔥 MSG=&quot;Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}&quot;</span>
<span class="w">    </span><span class="na">{% else %}</span>
<span class="w">        </span><span class="na">{% set density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">extruder_config.filament_density %}</span>
<span class="w">        </span><span class="na">{% set heat_capacity</span><span class="o">=</span><span class="s">extruder_config.filament_heat_capacity %}</span>

<span class="w">        </span><span class="na">RESPOND PREFIX</span><span class="o">=</span><span class="s">🔥 MSG=&quot;Unknown material &#39;{material}&#39;, using default mpc parameters for {heater}&quot;</span>
<span class="w">    </span><span class="na">{% endif %}</span>

<span class="w">    </span><span class="na">MPC_SET HEATER</span><span class="o">=</span><span class="s">{heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}</span>
</code></pre></div>

<p>The slicer must be configured to pass the current material type to your <code>PRINT_START</code> macro. For PrusaSlicer you should add the following parameter line to <code>print_start</code> in the Start G-Code section:</p>
<div class="highlight"><pre><span></span><code>MATERIAL=[filament_type[initial_extruder]]
</code></pre></div>

<p>The print_start line, in PrusaSlicer, would look like:</p>
<div class="highlight"><pre><span></span><code>start_print MATERIAL=[filament_type[initial_extruder]] EXTRUDER_TEMP={first_layer_temperature[initial_extruder]} BED_TEMP={first_layer_bed_temperature[initial_extruder]} CHAMBER_TEMP={chamber_temperature}
</code></pre></div>

<p>Then, in your <code>PRINT_START</code> macro include the following macro call:</p>
<div class="highlight"><pre><span></span><code>_SET_MPC_MATERIAL MATERIAL={params.MATERIAL}
</code></pre></div>

<h1 id="real-time-model-state">Real-Time Model State<a class="headerlink" href="#real-time-model-state" title="Permanent link">&para;</a></h1>
<p>The real-time temperatures and model states can be viewed from a browser by entering the following local address for your computer.</p>
<div class="highlight"><pre><span></span><code>https://192.168.xxx.xxx:7125/printer/objects/query?extruder
</code></pre></div>

<p><img alt="Calibration" src="/docs/img/MPC_realtime_output.png" /></p>
<h1 id="experimental-features">EXPERIMENTAL FEATURES<a class="headerlink" href="#experimental-features" title="Permanent link">&para;</a></h1>
<h2 id="bed-heater">Bed Heater<a class="headerlink" href="#bed-heater" title="Permanent link">&para;</a></h2>
<p>Using MPC for bed heater control is functional but the performance is not guaranteed or currently supported.  MPC for the bed can be configured simply.</p>
<div class="highlight"><pre><span></span><code>[heater_bed]
control: mpc
heater_power: 400
</code></pre></div>

<ul>
<li><code>control: mpc</code><br />
<em>Required</em><br />
  The temperature control method.  </li>
</ul>
<ul>
<li><code>heater_power: 50</code><br />
<em>Required</em><br />
  The nameplate heater power in watts.  </li>
</ul>
<ul>
<li><code>cooling_fan: fan_generic &lt;fan_name&gt;</code><br />
<em>No Default Value</em><br />
  This is the fan cooling the bed. Optional parameter to support bed fans.  </li>
</ul>
<p>The bed should be able to reach at least 90C to perform calibration with the following G-code. </p>
<p><code>MPC_CALIBRATE HEATER=&lt;heater&gt; [TARGET=&lt;temperature&gt;] [FAN_BREAKPOINTS=&lt;value&gt;]</code>  </p>
<ul>
<li><code>HEATER=&lt;heater&gt;</code>:<br />
  The bed heater to be calibrated.  </li>
</ul>
<ul>
<li><code>TARGET=&lt;temperature&gt;</code>:<br />
<em>Default Value: 90 (deg C)</em><br />
  Sets the calibration temperature. The default of 90C is a good target for the bed.  </li>
</ul>
<ul>
<li><code>FAN_BREAKPOINTS=&lt;value&gt;</code>:<br />
<em>Default Value: 3</em><br />
  Sets the number of fan setpoint to test during calibration.    </li>
</ul>
<p>Default calibration of the hotend with five fan breakpoints:  </p>
<div class="highlight"><pre><span></span><code>MPC_CALIBRATE HEATER=heater_bed FAN_BREAKPOINTS=5
</code></pre></div>

<p>These calibrated model parameters need to be saved to the <em>SAVE_CONFIG</em> block manually or by using the <code>SAVE_CONFIG</code> command.</p>
<h1 id="background">BACKGROUND<a class="headerlink" href="#background" title="Permanent link">&para;</a></h1>
<h2 id="mpc-algorithm">MPC Algorithm<a class="headerlink" href="#mpc-algorithm" title="Permanent link">&para;</a></h2>
<p>MPC models the hotend system as four thermal masses: ambient air, the filament, the heater block and the sensor. Heater power heats the modelled heater block directly. Ambient air heats or cools the heater block. Filament cools the heater block. The heater block heats or cools the sensor.  </p>
<p>Every time the MPC algorithm runs it uses the following information to calculate a new temperature for the simulated hotend and sensor:  </p>
<ul>
<li>The last power setting for the hotend.  </li>
<li>The present best-guess of the ambient temperature.  </li>
<li>The effect of the fan on heat-loss to the ambient air.  </li>
<li>The effect of filament feedrate on heat-loss to the filament. Filament is assumed to be at the same temperature as the ambient air.  </li>
</ul>
<p>Once this calculation is done, the simulated sensor temperature is compared to the measured temperature and a fraction of the difference is added to the modelled sensor and heater block temperatures. This drags the simulated system in the direction of the real system. Because only a fraction of the difference is applied, sensor noise is diminished and averages out to zero over time. Both the simulated and the real sensor exhibit the same (or very similar) latency. Consequently, the effects of latency are eliminated when these values are compared to each other. So, the simulated hotend is only minimally affected by sensor noise and latency.   </p>
<p>SMOOTHING is the factor applied to the difference between simulated and measured sensor temperature. At its maximum value of 1, the simulated sensor temperature is continually set equal to the measured sensor temperature. A lower value will result in greater stability in MPC output power but also in decreased responsiveness. A value around 0.25 seems to work quite well.  </p>
<p>No simulation is perfect and, anyway, real life ambient temperature changes. So MPC also maintains a best guess estimate of ambient temperature. When the simulated system is close to steady state the simulated ambient temperature is continually adjusted. Steady state is determined to be when the MPC algorithm is not driving the hotend at its limits (i.e., full or zero heater power) or when it is at its limit but temperatures are still not changing very much - which will occur at asymptotic temperature (usually when target temperature is zero and the hotend is at ambient).  </p>
<p>Steady_state_rate is used to recognize the asymptotic condition. Whenever the simulated hotend temperature changes at an absolute rate less than steady_state_rate between two successive runs of the algorithm, the steady state logic is applied. Since the algorithm runs frequently, even a small amount of noise can result in a fairly high instantaneous rate of change of hotend temperature. In practice 1°C/s seems to work well for steady_state_rate.  </p>
<p>When in steady state, the difference between real and simulated sensor temperatures is used to drive the changes to ambient temperature. However, when the temperatures are really close min_ambient_change ensures that the simulated ambient temperature converges relatively quickly. Larger values of min_ambient_change will result in faster convergence but will also cause the simulated ambient temperature to flutter somewhat chaotically around the ideal value. This is not a problem because the effect of ambient temperature is fairly small and short-term variations of even 10°C or more will not have a noticeable effect.  </p>
<p>It is important to note that the simulated ambient temperature will only converge on real world ambient temperature if the ambient heat transfer coefficients are exactly accurate. In practice this will not be the case and the simulated ambient temperature therefore also acts a correction to these inaccuracies.  </p>
<p>Finally, armed with a new set of temperatures, the MPC algorithm calculates how much power must be applied to get the heater block to target temperature in the next two seconds. This calculation takes into account the heat that is expected to be lost to ambient air and filament heating. This power value is then converted to a PWM output.  </p>
<h2 id="additional-details">Additional Details<a class="headerlink" href="#additional-details" title="Permanent link">&para;</a></h2>
<p>Please refer to that the excellent Marlin MPC Documentation for information on the model derivations, tuning methods, and heat transfer coefficients used in this feature.   </p>
<h1 id="acknowledgements">Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permanent link">&para;</a></h1>
<p>This feature is a port of the Marlin MPC implementation, and all credit goes to their team and community for pioneering this feature for open source 3D printing. The Marlin MPC documentation and github pages were heavily referenced and, in some cases directly copied and edited to create this document.  </p>
<ul>
<li>Marlin MPC Documentation: [<a href="https://marlinfw.org/docs/features/model_predictive_control.html">https://marlinfw.org/docs/features/model_predictive_control.html</a>]</li>
<li>GITHUB PR that implemented MPC in Marlin: [<a href="https://github.com/MarlinFirmware/Marlin/pull/23751">https://github.com/MarlinFirmware/Marlin/pull/23751</a>]</li>
<li>Marlin Source Code: [<a href="https://github.com/MarlinFirmware/Marlin">https://github.com/MarlinFirmware/Marlin</a>]</li>
</ul>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.top", "search.suggest", "search.highlight", "search.share"], "search": "assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.ebd0bdb7.min.js"></script>
      
    
  </body>
</html>